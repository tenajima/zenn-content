---
title: "dbt Style Guideを読む"
emoji: "📝"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["dbt"]
published: false
---

[こちらの記事](https://zenn.dev/tenajima/articles/dbt_best_practice)の続きです。
dbt style guideを元にプロジェクトを構築するといいと書かれていたので、dbt style guideを読んで行きます。
公式のリファレンス読むの大事ですよね。
例にもよってモチベーションは、同僚にも読んでもらってデファクトスタンダードを作るためです。

https://github.com/dbt-labs/corp/blob/master/dbt_style_guide.md


# まとめ


# Model Naming

- モデルは`staging`、`marts`、`base/intermediate`の3つのカテゴリーに分類される
- なぜこの設計を採用するかの詳細は[こちらのポスト](https://discourse.getdbt.com/t/how-we-structure-our-dbt-projects/355)を参照してね
  - なぜこの設計にするかの要約
    - 前提としてここで示す方法は、dbtとしてはベストだと思うが、自分自身のプロジェクトにとって最適かどうかは自分で判断してね(より深くディスカッションして使ってね)
     - Data transformatin 101
        - プロジェクトのデータは3つのチェックポイントで分けている
          - 1. Sources
            - データソースに準拠した構造(例えばテーブルやカラム)をサードバーティーツールで読み込んだもの
          - 2. Staging models
            - データモデリングの最小単位
            - 各モデルはソースデータテーブルと一対一の関係を持つ
            - 粒度は同じだが、カラムはリネーム、リキャストなど有用なものに整えられている状態にする
          - 3. Marts models
            - ビジネスプロセスやエンティティを表現するモデルで、ベースとなるデータソースから抽象化されている
        - ここで注目すべきなのはsourceとstagingはデータソースが基点なのに対して、martsはビジネスが基点であること
        - dbtおすすめのプロジェクトではまずmodelsディレクトリをを以下のように構成することから始めるべきだと思っている
        ```
        ├── dbt_project.yml
        └── models
            ├── marts
            └── staging
        ```
      - Staging raw data
        - staging層の目的は生データを受け取り、データクレンジングを行うことだ
        - `stg_`というプレフィックスを持つことは次のことを示す
          - データ基盤のルールに従ってフィールドをリネーム、リキャストしている
          - タイムゾーンなどのデータ型が揃っている
          - から文字をnullに置き換えるなどの簡単なクレンジングが行われている
          - 有用であればリストの展開(flattening)が行われている
          - ユニークかつ非null値であるプライマリキーがある
        - staging modelsはステージングモデルには、コンテキストやエンリッチメントのための追加カラムをフィールドとする結合が可能で、ユニオンによる行の追加やフィルタによる削除、ナチュラルキーの重複排除やサロゲートキーのハッシュ結合もできる
        - 複数のデータソースを扱うことが多いので、ステージングディレクトリでは、ソースごとに1つのディレクトリを作成する
        ```
        ├── dbt_project.yml
        └── models
            ├── marts
            └── staging
                ├── braintree
                └── stripe
        ```
        - それぞれのstagingディレクトリは最低限次のものを含む
          - 分析に有用な各オブジェクトに1つのstagingモデル
            - `stg_<source>__<object>`というファイル名にする
          - 1つの`src_<source>.yml`ファイル
            - sourceの定義、テスト、ドキュメントを記述する
          - 1つの`stg_<source>.yml`ファイル
            - 同じディレクトリのモデルのテストとドキュメントを書く
        ```
        ├── dbt_project.yml
        └── models
            ├── marts
            └── staging
                └── braintree
                    ├── src_braintree.yml
                    ├── stg_braintree.yml
                    ├── stg_braintree__customers.sql
                    └── stg_braintree__payments.sql
         ```
        - ymlファイルを1つにまとめたいという声も合理的だが、ymlが肥大化してきたらこの方法をお勧めする
        - ephemeral materializationをよく使うようになってきたらbaseディレクトリを使って作る
      - Describing a business through marts
        - martsはビジネスエンティティやビジネスロジックを含んだモデルを置くところ
        - ビジネスの単位でディレクトリを切るのが良い
          - マーケ、経理、プロダクト
        ```
        ├── dbt_project.yml
        └── models
            ├── marts
            |   ├── core
            |   ├── finance
            |   ├── marketing
            |   └── product
            └── staging        
        ```

            
        
- ファイル、ディレクトリ構造は次のようになるよ
```
├── dbt_project.yml
└── models
    ├── marts
    |   └── core
    |       ├── intermediate
    |       |   ├── intermediate.yml
    |       |   ├── customers__unioned.sql
    |       |   ├── customers__grouped.sql
    |       └── core.yml
    |       └── core.docs
    |       └── dim_customers.sql
    |       └── fct_orders.sql
    └── staging
        └── stripe
            ├── base
            |   ├── base__stripe_invoices.sql
            ├── src_stripe.yml
            ├── src_stripe.docs
            ├── stg_stripe.yml
            ├── stg_stripe__customers.sql
            └── stg_stripe__invoices.sql
```
