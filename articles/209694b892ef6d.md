---
title: "dbt snapshotã®Hard deletesã®æŒ™å‹•ã‚’ç¢ºèªã™ã‚‹"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["dbt", "BigQuery"]
published: false
---

# æ¦‚è¦

dbt snapshotã®hard deletesã£ã¦ã©ã‚“ãªæ„Ÿã˜ã§æŒ¯ã‚‹èˆã†ã‚“ã ã‚ã†ã£ã¦ã®ã‚’ç¢ºã‹ã‚ã¦ã„ã‚‹è¨˜äº‹ã§ã™

https://docs.getdbt.com/docs/building-a-dbt-project/snapshots#hard-deletes-opt-in

# é€šå¸¸ã®snapshot

## ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™

```sql
create or replace table lake.member
as
select
    member_id,
    age
from
    (
        select "hoge" as member_id, 12 age union all
        select "fuga" as member_id, 10 age
    )
```

## snapshotã‚’ã¨ã‚‹

```sql
{% snapshot member %}

{{
    config(
        target_schema="snapshots",
        unique_key="member_id",
        strategy="check",
        check_cols=[
            "age"
        ]
    )
}}

    select
        member_id,
        age
    from lake.member

{% endsnapshot %}
```

![](https://storage.googleapis.com/zenn-user-upload/68f1387b2032-20220411.png)

## ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™

```sql
create or replace table lake.member
as
select
    member_id,
    age
from
    (
        select "fuga" as member_id, 10 age
    )
```

## å†åº¦snapshotã‚’ã¨ã‚‹

å¤‰ã‚ã‚‰ãªã„
![](https://storage.googleapis.com/zenn-user-upload/b2f8d990c997-20220411.png)

# hard deleted

## ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™

```sql
create or replace table lake.member
as
select
    member_id,
    age
from
    (
        select "hoge" as member_id, 12 age union all
        select "fuga" as member_id, 10 age
    )
```

## snapshotã‚’ã¨ã‚‹
```sql
{% snapshot member %}

{{
    config(
        target_schema="snapshots",
        unique_key="member_id",
        strategy="check",
        check_cols=[
            "age"
        ],
        invalidate_hard_deletes=True,
    )
}}

    select
        member_id,
        age
    from lake.member

{% endsnapshot %}
```


## ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™

```sql
create or replace table lake.member
as
select
    member_id,
    age
from
    (
        select "fuga" as member_id, 10 age
    )
```

## å†åº¦snapshotã‚’ã¨ã‚‹

`dbt_valid_to`ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒå…¥ã‚‹ã‚“ã§ã™ã­ãƒ¼
ãªã‚‹ã»ã©

![](https://storage.googleapis.com/zenn-user-upload/fc78eb1158e0-20220411.png)

