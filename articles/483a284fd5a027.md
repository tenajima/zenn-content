---
title: "ä»®)ä»Šã¾ã§è²¯ã‚ãŸBigQueryã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’dbt snapshotã®ä¸–ç•Œã«æŒã£ã¦ã„ã"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["dbt", "GCP", "BigQuery"]
published: false
---

:::message
ã“ã®è¨˜äº‹ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨ã„ã£ã¦ã‚‹ã®ã¯ã€BigQueryã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å¾©å…ƒã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã¾ãŸã€ã‚¯ã‚¨ãƒªã¯BigQueryã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
:::

# æ¦‚è¦

- ãƒ‡ãƒ¼ã‚¿åŸºç›¤ã®ä¸­ã§å¤‰ã‚ã‚Šã†ã‚‹ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿(ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãªã©)ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ç½®ã„ã¦ãŠããŸã‚ã«æ¯æ—¥ãƒ¡ãƒ³ãƒãƒ¼æ•°åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚“ã§ä¿å­˜ã—ã¦ã„ã¾ã—ãŸ
- ã—ã‹ã—ã“ã‚Œã‚’ç¶šã‘ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿é‡ãŒè†¨å¤§ã«ãªã£ã¦ãã¦ã—ã¾ã„ã¾ã„ã¾ã™
- dbtã‚’å°å…¥ã™ã‚‹ã«ã‚ãŸã‚Šdbt snaphshotã§ã€å¤‰æ›´ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å–ã‚Šè¾¼ã‚€ã‚ˆã†ã«ã—ãŸããªã‚Šã¾ã—ãŸ
- ä»Šã¾ã§æ’®ã‚Šç¶šã‘ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚ãªã‚“ã¨ã‹dbt snapshotã®ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å–ã‚Šè¾¼ã¿ãŸã„ã¨æ€ã„æ ¼é—˜ã—ãŸè¨˜éŒ²ã‚’ã“ã“ã«è¨˜ãã†ã¨æ€ã„ã¾ã™

## ã¡ãªã¿ã«

ã„ã¤ã‹ã‚‰ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚Šå§‹ã‚ã‚‹ã¨ã„ã„ã®ï¼Ÿã¨ã„ã†è³ªå•ã«å¯¾ã—ã¦ã“ã®ãƒ–ãƒ­ã‚°ã§ã¯ã“ã®ã‚ˆã†ã«è¿°ã¹ã¦ã¾ã™

> The best time to start snapshotting your data was twenty years ago.
> The second best time is today.

æ—©ãæ’®ã‚Šå§‹ã‚ãªã„ã¨ã“ã®è¨˜äº‹ã§è¿°ã¹ã¦ã„ãã‚ˆã†ã«ä¸€æ‰‹é–“åŠ ãˆãªã„ã¨ã„ã‘ãªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

https://blog.getdbt.com/track-data-changes-with-dbt-snapshots/


# æ‰±ã†ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹

## ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œã‚‹

`lake`ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œã£ã¦ãã“ã«ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½œã‚ã†ã¨æ€ã„ã¾ã™ã€‚

```sql
create schema lake
options(
    location="asia-northeast1"
)
```

## æ—¢å­˜ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œã‚‹

`old_snapshot`ã¨ã„ã†åå‰ã«ã—ã¦æ—¢å­˜ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œã‚Šã¾ã™ã€‚
ãƒ¡ãƒ³ãƒãƒ¼ã®idã¨statusã¨ã„ã¤ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚’è¡¨ã™ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ãƒ¼ãƒ–ãƒ«ã«ã—ã¾ã™ã€‚

```sql
create or replace table lake.old_snapshot
as
with snapshot_20220101 as (
    select
        member_id,
        member_status,
        date(2022, 1, 1) snapshot_date
    from
        (
            select "hoge" as member_id, "actiave" member_status union all
            select "fuga" as member_id, "active" member_status
        )
),
snapshot_20220102 as (
    select
        member_id,
        member_status,
        date(2022, 1, 2) snapshot_date
    from
        (
            select "hoge" as member_id, "active" member_status union all
            select "fuga" as member_id, "active" member_status
        )
),
snapshot_20220103 as (
    select
        member_id,
        member_status,
        date(2022, 1, 3) snapshot_date
    from
        (
            select "hoge" as member_id, "deactive" member_status union all
            select "fuga" as member_id, "active" member_status
        )
),
final as (
    select * from snapshot_20220101 union all
    select * from snapshot_20220102 union all
    select * from snapshot_20220103
)
select * from final
```

![](https://storage.googleapis.com/zenn-user-upload/dc0bafb69f04-20220327.png)

hogeã•ã‚“ã¨fugaã•ã‚“ãŒã„ã¦ã€1æœˆ2æ—¥ã«ã¯ä½•ã‚‚å¤‰æ›´ãŒèµ·ãã¦ãŠã‚‰ãš1æœˆ3æ—¥ã«hogeã•ã‚“ãŒdeactivateã«ãªã£ã¦ã„ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã€‚

## ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½œã‚‹

ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ãªã‚‹ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯ä»Šã®çŠ¶æ…‹ã®ã¿ã‚’è¡¨ã™ã‚‚ã®ã«ã—ã¾ã™ã€‚

```sql
create or replace table lake.member
as
select
    member_id,
    member_status
from
    (
        select "hoge" as member_id, "deactive" member_status union all
        select "fuga" as member_id, "deactive" member_status
    )

```

![](https://storage.googleapis.com/zenn-user-upload/0106bc728d65-20220326.png)

æœ€æ–°ã®çŠ¶æ…‹ã§ã¯ã©ã¡ã‚‰ã‚‚deactivateã«ãªã£ã¦ã„ã¾ã™ã€‚

# dbt snapshotã®æº–å‚™ã‚’ã™ã‚‹

dbtã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦snapshotsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«member.sqlã¨ã—ã¦ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®ãŸã‚ã®ã‚¯ã‚¨ãƒªã‚’ç”¨æ„ã—ã¾ã™ã€‚
```sql
{% snapshot member %}

{{
    config(
        target_schema="snapshots",
        unique_key="member_id",
        strategy="check",
        check_cols=[
            "member_status"
        ]
    )
}}

    select
        member_id,
        member_status
    from lake.member

{% endsnapshot %}
```

`dbt snapshot`ã‚’å®Ÿè¡Œã™ã‚‹ã¨
![](https://storage.googleapis.com/zenn-user-upload/4a7eb9552b33-20220326.png)

æœ€æ–°ã®æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ’®ã£ã¦ã‚ã‚‹åˆ†ã‚‚ã“ã“ã«è¿½åŠ ã—ãŸã„ï¼ã¨ã„ã†ã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ã‚¨ãƒªã«ã¤ã„ã¦

## å‰æ—¥ã¨ã®æ¯”è¼ƒ

ä»Šå›å¤‰ã‚ã‚Šã†ã‚‹ã®ã¯`member_status`ã§ã™ã€‚
å‰æ—¥ã®`member_status`ã‚’ã‚«ãƒ©ãƒ ã«è¿½åŠ ã—ã¾ã™ã€‚
ä¸€ç•ªåˆã‚ã®æ—¥ä»˜ã«ã¯`null`ãŒå…¥ã‚Šã¾ã™ã€‚

```sql
select 
    *,
    lag(member_status, 1) over(partition by member_id order by snapshot_date) lag_member_status,
from member_master
```
![](https://storage.googleapis.com/zenn-user-upload/76041f8bf65e-20220328.png)

## å¤‰æ›´ãŒã‚ã£ãŸéƒ¨åˆ†ã«flagã‚’ã¤ã‘ã‚‹

æœ€å¤ã®ãƒ‡ãƒ¼ã‚¿(`null`ã®éƒ¨åˆ†)ã¨å¤‰æ›´ãŒã‚ã£ãŸéƒ¨åˆ†ã«flagã‚’ã¤ã‘ã¾ã™ã€‚

```sql
select
    *,
    if(lag_member_status is null or member_status != lag_member_status, 1, 0) modified_flag
from member_with_lag
```

![](https://storage.googleapis.com/zenn-user-upload/62baa6c0a740-20220328.png)

## å¤‰æ›´ãŒèµ·ãã¦ã‹ã‚‰æ¬¡ã«èµ·ãã‚‹ã¾ã§ã‚’ã²ã¨ã¾ã¨ã¾ã‚Šã«ã™ã‚‹

è¨€èªåŒ–ã™ã‚‹ã®ãŒé›£ã—ã„ã®ã§ã™ãŒ`dbt_valid_from`ã¨`dbt_valid_to`ã‚’ä½œã‚‹ãŸã‚ã®ä½œæ¥­ã§ã™ã€‚
ã¾ã¨ã¾ã‚Šã‚’`rank`ã¨ã„ã†è¨€è‘‰ã‚’ä½¿ã£ã¦è¡¨ã—ã¦ã„ã¾ã™ã€‚

```sql
select
    *,
    sum(modified_flag) over(partition by member_id order by snapshot_date) rank,
from member_with_flag
```
![](https://storage.googleapis.com/zenn-user-upload/3d71b927e0df-20220328.png)

## æœ€çµ‚çš„ãªã‚¯ã‚¨ãƒª

ã“ã“ã¾ã§ã§ããŸã‚‰`rank`ã”ã¨ã«`snapshot_date`ã®minã¨maxã‚’ã¨ã£ã¦dbt snapshotç”¨ã«ã¡ã‚‡ã£ã¨æ•´ãˆã¦ã‚ã’ã¾ã™ã€‚
DDLã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚‹ã¨ã“ã‚ã‚‚ä½µã›ãŸæœ€çµ‚çš„ãªã‚¯ã‚¨ãƒªã¯ã“ã¡ã‚‰ã«ãªã‚Šã¾ã™

```sql
create table if not exists snapshots.member
(
    member_id string not null,
    member_status string not null,
    dbt_scd_id string not null,
    dbt_updated_at timestamp not null,
    dbt_valid_from timestamp not null,
    dbt_valid_to timestamp
)
partition by date(dbt_updated_at)
as
with param as (
    select
        date(2022, 01, 03) snapshot_date_end
),
member_master as (
    select
        *
    from `lake.old_snapshot`,
    param
    where
        snapshot_date <= param.snapshot_date_end
),
member_with_lag as (
    select 
        *,
        lag(member_status, 1) over(partition by member_id order by snapshot_date) lag_member_status,
    from member_master
),
member_with_flag as (
    select
        *,
        if(lag_member_status is null or member_status != lag_member_status, 1, 0) modified_flag
    from member_with_lag
),
member_with_rank as (
    select
        *,
        sum(modified_flag) over(partition by member_id order by snapshot_date) rank,
    from member_with_flag
),
member_history as (
    select
        member_id,
        rank,
        min(snapshot_date) dbt_valid_from,
        max(snapshot_date) dbt_valid_to,
    from member_with_rank
    group by 1, 2
),
final as (
    select
        member_history.member_id,
        member_master.member_status,
        generate_uuid() dbt_scd_id,
        timestamp(member_history.dbt_valid_from) dbt_updated_at,
        timestamp(member_history.dbt_valid_from) dbt_valid_from,
        timestamp(if(dbt_valid_to = param.snapshot_date_end, null, date_add(dbt_valid_to, interval 1 day))) dbt_valid_to
    from member_history, param
    left join member_master
    on member_history.member_id = member_master.member_id
    and member_history.dbt_valid_from = member_master.snapshot_date
)
select * from final
```

çµæœã¯ã“ã¡ã‚‰ã§ã™
![](https://storage.googleapis.com/zenn-user-upload/e5b6d26be839-20220328.png)
å®Ÿã¯ã¡ã‚‡ã£ã¨`dbt_scd_id`ãŒæ®‹å¿µãªæ„Ÿã˜ã§ã¯ã‚ã‚Šã¾ã™...

# dbt snapshotã‚’å®Ÿè¡Œã™ã‚‹

æœ€å¾Œã«dbt snapshotã‚’å®Ÿè¡Œã—ã¦è‡ªåˆ†ã§ç”¨æ„ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã¨ä¸–ç•Œç·šã‚’èåˆã•ã›ã¾ã™ã€‚
çµæœãŒã“ã¡ã‚‰ã«ãªã‚Šã¾ã™
`dbt_scd_id`ãŒå°‘ã—æ®‹å¿µã§ã™ã­ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8105aab4616b-20220328.png)

ã—ã‹ã—ã»ã—ã„ã‚‚ã®ã¯æ‰‹ã«å…¥ã‚Šã¾ã—ãŸã€‚
ã“ã‚Œã§dbtã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã£ã¦ã„ãä¸–ç•Œç·šã«è¸ã¿å‡ºã›ã¾ã™ã­ã€‚
